<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YourGP Phone Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script type="text/javascript" src="https://js.live.net/v7.2/OneDrive.js"></script>
    <link rel="stylesheet" href="dashboard.css">
</head>
<body>
    <div class="header">
        <h1>YourGP Phone Dashboard</h1>
        <div class="controls">
            <div class="file-upload-container">
                <div class="file-upload">
                    <input type="file" id="fileInput" accept=".csv" multiple>
                    <label for="fileInput">Upload from Computer</label>
                </div>
                <button class="btn onedrive-btn" id="oneDriveBtn" onclick="launchOneDrivePicker()">
                    Open from OneDrive
                </button>
            </div>
            <div class="week-info" id="weekInfo">No data loaded</div>
            <div class="service-level-selector">
                <label for="weekSelector">Week:</label>
                <select id="weekSelector" onchange="setWeekFilter()">
                    <option value="all">All Weeks</option>
                </select>
            </div>
            <label class="toggle-label" title="Show weekly averages instead of totals">
                <input type="checkbox" id="avgToggle" onchange="toggleWeeklyAverages()">
                <span>Weekly Avg</span>
            </label>
            <div class="view-toggle" id="queueToggle">
                <button class="btn active" id="queueAll" onclick="setQueueFilter('all')">All</button>
                <button class="btn" id="queueAppointments" onclick="setQueueFilter('appointments')">Appointments</button>
                <button class="btn" id="queueVasectomy" onclick="setQueueFilter('vasectomy')">Vasectomy</button>
                <button class="btn" id="queueGeneral" onclick="setQueueFilter('general')">General</button>
                <button class="btn" id="queueHealth" onclick="setQueueFilter('health')">Health Pro</button>
                <button class="btn" id="queueNone" onclick="setQueueFilter('noqueue')">No Queue</button>
            </div>
            <div class="service-level-selector">
                <label for="globalLocationFilter">Location:</label>
                <select id="globalLocationFilter" onchange="setGlobalLocation()">
                    <option value="all">All Locations</option>
                    <option value="crace">Crace</option>
                    <option value="denman">Denman</option>
                    <option value="lyneham">Lyneham</option>
                </select>
            </div>
        </div>
    </div>

    <div id="loading">Loading and processing data...</div>

    <div id="noData" class="no-data">
        <h3>No Data Loaded</h3>
        <p>Upload CSV files: main export (ExportCallRecords_*.csv) and optionally queue files (CallQueue_Detailed_*.csv).</p>
    </div>

    <div id="dashboard" style="display: none;">
        <!-- Summary Metrics -->
        <p style="font-size: 12px; color: #7f8c8d; margin-bottom: 10px;">Note: Statistics are filtered by queue selection above. Hover over cards for explanations.</p>
        <div class="metrics-grid" id="metricsGrid">
            <div class="metric-card" title="Total incoming calls during opening hours">
                <div class="value" id="totalCalls">-</div>
                <div class="label">Total Calls</div>
            </div>
            <div class="metric-card success" title="Calls that were picked up by staff">
                <div class="value" id="answeredCalls">-</div>
                <div class="label">Answered</div>
            </div>
            <div class="metric-card danger" title="Calls that entered a queue but were not answered">
                <div class="value" id="missedCalls">-</div>
                <div class="label">Missed</div>
            </div>
            <div class="metric-card danger" title="Percentage of calls that entered a queue but were missed">
                <div class="value" id="missedPercent">-</div>
                <div class="label">Missed %</div>
            </div>
            <div class="metric-card info" title="Percentage of calls answered within the target time (configurable below)">
                <div class="value" id="serviceLevel">-</div>
                <div class="label">Service Level</div>
            </div>
            <div class="metric-card success" title="First Call Resolution - estimated percentage of callers who didn't need to call back within 24 hours">
                <div class="value" id="fcrRate">-</div>
                <div class="label">FCR (Est.)</div>
            </div>
            <div class="metric-card warning" title="Percentage of unique callers who called more than once within 24 hours">
                <div class="value" id="callbackRate">-</div>
                <div class="label">Callback Rate</div>
            </div>
            <div class="metric-card" title="Average time callers waited before being answered">
                <div class="value" id="avgWait">-</div>
                <div class="label">Avg Wait</div>
            </div>
            <div class="metric-card" title="Longest wait time for any answered call in this period">
                <div class="value" id="maxWait">-</div>
                <div class="label">Max Wait</div>
            </div>
            <div class="metric-card" title="Average duration of answered calls (excluding ring time)">
                <div class="value" id="avgCallLength">-</div>
                <div class="label">Avg Call Length</div>
            </div>
            <div class="metric-card purple" title="Incoming calls received outside business hours (not included in other metrics)">
                <div class="value" id="outOfHoursCalls">-</div>
                <div class="label">Out of Hours</div>
            </div>
        </div>

        <!-- Service Level Target Selector -->
        <div style="margin-bottom: 20px; display: flex; align-items: center; gap: 15px;">
            <div class="service-level-selector">
                <label for="slTarget">Service Level Target:</label>
                <select id="slTarget" onchange="updateServiceLevelTarget()">
                    <option value="30">30 seconds</option>
                    <option value="60">60 seconds</option>
                    <option value="90" selected>90 seconds</option>
                    <option value="120">120 seconds</option>
                </select>
            </div>
        </div>

        <!-- Hourly Trend and Abandonment Analysis -->
        <div class="two-col-grid">
            <!-- Hourly Trend Chart -->
            <div class="section">
                <h2>Hourly Call Volume</h2>
                <div class="chart-container">
                    <canvas id="hourlyChart"></canvas>
                </div>
            </div>

            <!-- Abandonment Analysis -->
            <div class="section">
                <h2>Abandonment Analysis</h2>
                <p style="font-size: 12px; color: #7f8c8d; margin-bottom: 10px;">Wait time before caller hung up (missed calls only)</p>
                <div style="display: flex; gap: 20px; align-items: center; margin-bottom: 15px;">
                    <div>
                        <span style="font-size: 11px; color: #7f8c8d;">Total Abandoned:</span>
                        <span id="totalAbandoned" style="font-size: 18px; font-weight: 700; color: #e74c3c; margin-left: 5px;">-</span>
                    </div>
                    <div>
                        <span style="font-size: 11px; color: #7f8c8d;">Avg Wait Before Abandon:</span>
                        <span id="avgAbandonWait" style="font-size: 18px; font-weight: 700; color: #e74c3c; margin-left: 5px;">-</span>
                    </div>
                </div>
                <div class="abandonment-grid" id="abandonmentGrid">
                    <!-- Filled by JS -->
                </div>
            </div>
        </div>

        <!-- Missed Call Follow-up Analysis -->
        <div class="section">
            <div class="section-header">
                <h2 id="followupHeader">Missed Call Follow-up (24h Window)</h2>
                <div class="service-level-selector">
                    <label for="callbackWindow">Window:</label>
                    <select id="callbackWindow" onchange="updateCallbackWindow()">
                        <option value="24" selected>24 hours</option>
                        <option value="48">2 days</option>
                        <option value="72">3 days</option>
                    </select>
                </div>
            </div>
            <p style="font-size: 12px; color: #7f8c8d; margin-bottom: 15px;">What happens to callers whose first call was missed?</p>

            <div class="followup-cards">
                <div class="followup-card lost">
                    <div class="big-number" id="lostOpportunities">-</div>
                    <div class="card-label">Lost Opportunities</div>
                    <div class="card-detail">(never called back)</div>
                    <div class="card-detail" id="lostPeakHour" style="margin-top: 5px; font-weight: 500;">-</div>
                </div>
                <div class="followup-card persistent">
                    <div class="big-number" id="persistentCallers">-</div>
                    <div class="card-label">Persistent Callers</div>
                    <div class="card-detail">(called back)</div>
                    <div class="card-detail" id="avgAttempts" style="margin-top: 5px; font-weight: 500;">-</div>
                </div>
            </div>

            <button class="expand-btn" id="followupExpandBtn" onclick="toggleFollowupDetails()">
                <span class="arrow">&#9660;</span> Show Details
            </button>

            <div class="detail-section" id="followupDetails">
                <h4>Callback Attempts Distribution</h4>
                <div class="detail-grid" id="attemptsGrid"></div>

                <h4>Lost Opportunity Peak Hours</h4>
                <div class="peak-hours" id="lostPeakHours"></div>

                <div style="margin-top: 15px;">
                    <span style="font-size: 11px; color: #7f8c8d;">Avg Wait Before Hanging Up:</span>
                    <span id="avgWaitBeforeHangup" style="font-size: 16px; font-weight: 600; color: #e74c3c; margin-left: 8px;">-</span>
                </div>
            </div>
        </div>

        <!-- Week-over-Week Trends -->
        <div class="section" id="weekTrendsSection" style="display: none;">
            <h2>Week-over-Week Trends</h2>
            <p style="font-size: 12px; color: #7f8c8d; margin-bottom: 10px;">Shows trends when multiple weeks of data are loaded</p>
            <div class="chart-container">
                <canvas id="weekTrendChart"></canvas>
            </div>
        </div>

        <!-- Site Breakdown -->
        <div class="section">
            <h2>Site Breakdown</h2>
            <table id="siteTable">
                <thead>
                    <tr>
                        <th style="text-align: left;">Site</th>
                        <th>Total Calls</th>
                        <th>Answered</th>
                        <th>Missed</th>
                        <th>Missed %</th>
                        <th>Avg Wait</th>
                        <th>Max Wait</th>
                        <th>Avg Call Length</th>
                    </tr>
                </thead>
                <tbody id="siteTableBody"></tbody>
            </table>
        </div>

        <!-- Direction Tabs for Daily Table -->
        <div class="section">
            <h2>Daily Breakdown</h2>
            <div class="direction-tabs">
                <button class="btn active" id="tabInOut" onclick="setDailyDirection('all')">All</button>
                <button class="btn" id="tabIn" onclick="setDailyDirection('in')">Calls In</button>
                <button class="btn" id="tabOut" onclick="setDailyDirection('out')">Calls Out</button>
            </div>
            <table id="dailyTable">
                <thead>
                    <tr>
                        <th>Metric</th>
                        <th>Mon</th>
                        <th>Tue</th>
                        <th>Wed</th>
                        <th>Thu</th>
                        <th>Fri</th>
                        <th>Sat</th>
                        <th>Sun</th>
                        <th>Week</th>
                    </tr>
                </thead>
                <tbody id="dailyTableBody"></tbody>
            </table>
        </div>

        <!-- Heatmaps -->
        <div class="section">
            <div class="section-header">
                <h2>Call Volume Heatmaps (7:30 AM - 5:30 PM)</h2>
                <div class="service-level-selector">
                    <label for="heatmapLocationFilter">Location:</label>
                    <select id="heatmapLocationFilter" onchange="updateHeatmapLocation()">
                        <option value="all">All Locations</option>
                        <option value="crace">Crace</option>
                        <option value="denman">Denman</option>
                        <option value="lyneham">Lyneham</option>
                    </select>
                </div>
            </div>
            <div class="heatmap-legend" style="display: flex; align-items: center; gap: 8px; margin-bottom: 15px; font-size: 11px; color: #6c757d;">
                <span>Low</span>
                <div style="display: flex; gap: 2px;">
                    <div style="width: 20px; height: 14px; background: #e3f2fd; border-radius: 2px;"></div>
                    <div style="width: 20px; height: 14px; background: #90caf9; border-radius: 2px;"></div>
                    <div style="width: 20px; height: 14px; background: #42a5f5; border-radius: 2px;"></div>
                    <div style="width: 20px; height: 14px; background: #1565c0; border-radius: 2px;"></div>
                </div>
                <span>High</span>
            </div>
            <div class="heatmap-container">
                <div>
                    <h3 style="font-size: 14px; margin-bottom: 10px; color: #1565c0; font-weight: 600;">Calls In</h3>
                    <div class="heatmap-wrapper">
                        <div class="heatmap" id="heatmapIn"></div>
                    </div>
                </div>
                <div>
                    <h3 style="font-size: 14px; margin-bottom: 10px; color: #7cb342; font-weight: 600;">Calls Out</h3>
                    <div class="heatmap-wrapper">
                        <div class="heatmap" id="heatmapOut"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Wait Time Heatmaps -->
        <div class="section">
            <h2>Wait Time Heatmaps (7:30 AM - 5:30 PM)</h2>
            <p style="font-size: 12px; color: #7f8c8d; margin-bottom: 10px;">Incoming calls only. Hover over cells for exact times.</p>
            <div class="heatmap-legend" style="display: flex; align-items: center; gap: 8px; margin-bottom: 15px; font-size: 11px; color: #6c757d;">
                <span>&lt;30s</span>
                <div style="display: flex; gap: 2px;">
                    <div style="width: 20px; height: 14px; background: #e8f5e9; border-radius: 2px;"></div>
                    <div style="width: 20px; height: 14px; background: #fff3e0; border-radius: 2px;"></div>
                    <div style="width: 20px; height: 14px; background: #ffab91; border-radius: 2px;"></div>
                    <div style="width: 20px; height: 14px; background: #c62828; border-radius: 2px;"></div>
                </div>
                <span>&gt;5min</span>
            </div>
            <div class="heatmap-container">
                <div>
                    <h3 style="font-size: 14px; margin-bottom: 10px; color: #c62828; font-weight: 600;">Max Wait Time</h3>
                    <div class="heatmap-wrapper">
                        <div class="heatmap" id="heatmapMaxWait"></div>
                    </div>
                </div>
                <div>
                    <h3 style="font-size: 14px; margin-bottom: 10px; color: #f57c00; font-weight: 600;">Avg Wait Time</h3>
                    <div class="heatmap-wrapper">
                        <div class="heatmap" id="heatmapAvgWait"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Staff Performance -->
        <div class="section">
            <div class="section-header">
                <h2>Staff Performance</h2>
                <div class="service-level-selector">
                    <label for="locationFilter">Location:</label>
                    <select id="locationFilter" onchange="updateStaffTableFilter()">
                        <option value="all">All Locations</option>
                        <option value="crace">Crace</option>
                        <option value="denman">Denman</option>
                        <option value="lyneham">Lyneham</option>
                    </select>
                </div>
            </div>
            <table id="staffTable">
                <thead>
                    <tr>
                        <th style="text-align: left;">Staff Member</th>
                        <th>Calls In</th>
                        <th>Calls Out</th>
                        <th>Total Calls</th>
                        <th>Avg Pickup Time</th>
                        <th>Avg Call In</th>
                        <th>Avg Call Out</th>
                    </tr>
                </thead>
                <tbody id="staffTableBody"></tbody>
            </table>
        </div>
    </div>

    <script src="dashboard.js"></script>
</body>
</html>
